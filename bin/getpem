#!/usr/bin/env php
<?php

use Informeren\OAuth2\Client\JWK\KeySet;
use Informeren\OAuth2\Client\Provider\MobilePay;

require __DIR__ . '/../vendor/autoload.php';

if ($argc !== 2) {
    print "Usage: getpem [jwks_uri]\n";
    exit(1);
}

$jwks_uri = $argv[1];

$provider = new MobilePay([
    'clientId' => getenv('CLIENT_ID'),
    'clientSecret' => getenv('CLIENT_SECRET'),
    'discoveryUri' => getenv('DISCOVERY_URI'),
    'redirectUri' => getenv('REDIRECT_URI'),
]);

try {
    $request = $provider->getRequest('GET', $jwks_uri);
    $response = $provider->getResponse($request);

    $keyset = KeySet::fromJson($response->getBody());

    foreach ($keyset as $key) {
        print 'Key ID: ' . $key->getId() . "\n\n";
        print $key->toPem() . "\n\n";
    }
} catch (Throwable $o_O) {
    printf('Unable to get public key: %s', $o_O->getMessage());
}
